#!/usr/bin/env bash
#
# Â© 2017 Konstantin Gredeskoul
 
[[ -d bin/lib ]] || { 
  printf "Please run this script from the project's root\n"
exit 1
}

source bin/lib/loader

def_ruby_ver="2.4.2"
dep_dir="./cmake/.arduino-cmake"
dep_url="https://github.com/arduino-cmake/arduino-cmake" 

function setup::ruby::ruby-install() {
  local dir=$(pwd)
  cd /tmp
  run "wget -O ruby-install-0.6.1.tar.gz https://github.com/postmodern/ruby-install/archive/v0.6.1.tar.gz"
  run "tar -xzvf ruby-install-0.6.1.tar.gz"
  cd ruby-install-0.6.1/
  run "sudo make install"
}

function setup::ruby::install() {
  local version=${1:-${def_ruby_version}}

  [[ -z $(ruby-install --help 2>/dev/null) ]] && setup::ruby::ruby-install

  run "ruby-install ruby ${version}"
}

function setup::git() {
  if [[ -d ${dep_dir} ]]; then
    cd ${dep_dir}
    run "git pull --rebase"
    cd - >/dev/null
  else
    run "git clone ${dep_url} ${dep_dir}"
  fi
}

function setup::symlinks() {
  for file in $(ls -1 ${dep_dir}/cmake); do
    cd cmake
    run "ln -nfs ./.arduino-cmake/cmake/$file"
    cd - > /dev/null
  done
}

function setup::install::arli() {
  local ruby_version=$(ruby --version 2>/dev/null | awk '{print $2}')
  
  if [[ -z ${ruby_version} || ! ${ruby_version} =~ '2.' ]]; then 
    error "You do not have a recent Ruby version installed"
    info "I could install it for you... May I [Y/n]? "
    read a
    if [[ $a == '' || $a == 'y' || $a == 'Y' ]]; then
      ok: 
      info "Alright then, let's do this :) "
      info "Installing Ruby ${def_ruby_ver}"
      setup::ruby::install "${def_ruby_ver}"
      ok:
    fi
  fi

  if [[ $(which gem) =~ '/usr/' ]]; then
    run "sudo gem install arli --no-rdoc --no-ri"
  else
    run "gem install arli --no-rdoc --no-ri"
  fi
} 

function setup() { 
  setup::install::arli
  setup::git
  setup::symlinks
}

setup
